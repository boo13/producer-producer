---
phase: 05-settings-newsletter
plan: 01
type: execute
---

<objective>
Add login modal and settings modal with newsletter toggle to v2.

Purpose: Enable authentication and user configuration in the mobile-first interface, completing the core feature set before visual polish.
Output: Working login flow with newsletter opt-in, and settings modal for managing preferences.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (from frontmatter):
@.planning/phases/04-add-job/04-01-SUMMARY.md

# Key files to reference:
@v2/index.html
@v2/css/styles.css
@v2/js/api.js
@v2/js/auth.js

# v1 reference patterns:
@js/settings.js

**Tech stack available:** VT323 font, vanilla JS, IIFE modules
**Established patterns:**
- Modal pattern with backdrop click (from 04-01 add-job modal)
- Form validation with inline errors (from 04-01)
- Toast feedback (undo-toast styling)
- Event-based auth updates (pp:auth-changed custom event)
- API methods: getUserConfig(), updateUserConfig(), requestMagicLink()

**Constraining decisions:**
- Phase 01-01: auth.js dispatches pp:auth-changed event (UI listens and updates)
- Phase 04-01: Toast reuses undo-toast styling (consistent feedback)
- Phase 04-01: Modal overlay pattern with backdrop click handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Login Modal HTML and CSS</name>
  <files>v2/index.html, v2/css/styles.css</files>
  <action>
Add login modal structure to index.html after the add-job modal:
- Modal overlay with same pattern as add-job-modal (.login-modal)
- Content box with email input, newsletter checkbox, and submit button
- Close button (X) in corner
- Hidden by default

Add login button in header (next to nav tabs):
- Simple gear/user icon or "Login" text button
- Hidden when authenticated, shown when not

CSS for login modal:
- Reuse .add-job-modal layout pattern (fixed overlay, centered content)
- Email input uses same styling as .add-job__input
- Newsletter checkbox with label (styled for terminal aesthetic)
- Submit button uses same styling as .add-job__submit
- Error display area below form

Newsletter checkbox specific:
- Custom checkbox styling (green checkmark on dark bg)
- Label text: "Subscribe to weekly job digest"
- Default checked (opt-out model)
  </action>
  <verify>Open v2/index.html in browser, login modal HTML present but hidden, login button visible in header</verify>
  <done>Login modal HTML/CSS complete, visually matches add-job modal pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create login.js module with form handling</name>
  <files>v2/js/login.js, v2/index.html</files>
  <action>
Create v2/js/login.js as IIFE module:

Functions needed:
- initLoginModal(): Set up event listeners for open/close/submit
- openLogin(): Show modal
- closeLogin(): Hide modal
- handleLoginSubmit(e): Validate email, call requestMagicLink, show success/error
- updateLoginButtonVisibility(): Show/hide login button based on auth state

Event handling:
- Login button click → openLogin()
- Modal backdrop click → closeLogin()
- Close button click → closeLogin()
- Form submit → handleLoginSubmit()
- Listen for pp:auth-changed → updateLoginButtonVisibility()

Newsletter handling in login:
- Read checkbox state before submitting
- If checked, call api.updateUserConfig({ digest_enabled: true }) after successful magic link request
- Note: This requires user to exist first, so newsletter preference is set on NEXT login after account creation

Success flow:
- On magic link sent, show success message using toast pattern
- "Magic link sent! Check your email."
- Close modal after 2 seconds

Error flow:
- Show error in modal's error display area
- Keep modal open for retry

Add script tag to index.html before closing body.
  </action>
  <verify>Click login button → modal opens, enter email → "Magic link sent" toast appears, modal closes</verify>
  <done>Login flow works: enter email → API called → success toast → modal closes</done>
</task>

<task type="auto">
  <name>Task 3: Add Settings Modal HTML, CSS, and JS</name>
  <files>v2/index.html, v2/css/styles.css, v2/js/settings.js</files>
  <action>
Add settings modal to index.html:
- Modal structure like login-modal (.settings-modal)
- Form with fields: Newsletter toggle (checkbox), Digest threshold (number input)
- Keep other settings minimal for v2 (locations, keywords can be added later)
- Save and Cancel buttons

Add settings button in header:
- Gear icon or "Settings" text next to login button
- Only visible when authenticated

CSS for settings modal:
- Reuse modal overlay pattern
- Form fields use same input styling
- Toggle/checkbox uses same custom styling as login newsletter checkbox

Create v2/js/settings.js as IIFE module:
- initSettings(): Set up event listeners
- openSettings(): Fetch config via api.getUserConfig(), populate form, show modal
- closeSettings(): Hide modal
- handleSettingsSave(e): Collect form data, call api.updateUserConfig(), show toast, close
- updateSettingsButtonVisibility(): Show/hide based on auth state

Form fields:
- Newsletter toggle: digest_enabled (boolean)
- Digest threshold: digest_threshold (number 0-100, default 80)
- Keep simple - no locations/keywords for v2 (can expand later)

Event handling:
- Settings button click → openSettings()
- Modal backdrop click → closeSettings()
- Save button click → handleSettingsSave()
- Cancel button click → closeSettings()
- Listen for pp:auth-changed → updateSettingsButtonVisibility()

Add script tag to index.html.
  </action>
  <verify>Login, click settings → modal shows current config, toggle newsletter → save → toast confirms, reload → setting persists</verify>
  <done>Settings modal works: opens with current config, saves changes via API</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Login modal opens when not authenticated
- [ ] Magic link request works (check browser network tab for API call)
- [ ] Success toast appears and modal closes
- [ ] Settings button only visible when authenticated
- [ ] Settings modal shows current config from API
- [ ] Settings save persists (verify by reopening settings)
- [ ] Newsletter checkbox in login works (visual check)
- [ ] All modals close on backdrop click
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Login flow functional (email → API → success message)
- Settings save/load functional
- UI matches terminal aesthetic (VT323 font, green/dark colors)
</success_criteria>

<output>
After completion, create `.planning/phases/05-settings-newsletter/05-01-SUMMARY.md`:

# Phase 05 Plan 01: Login & Settings Modals Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `v2/index.html` - Added login and settings modals
- `v2/css/styles.css` - Modal and form styling
- `v2/js/login.js` - Login modal module
- `v2/js/settings.js` - Settings modal module

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 5 complete, ready for Phase 6 (Visual Polish)
</output>
